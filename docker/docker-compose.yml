services:
  theme-agent:
    stdin_open: true
    tty: true
    build:
      context: ..
      dockerfile: docker/Dockerfile

    env_file:
      - .env

    volumes:
      - ../tasks:/app/tasks
      - ../runs:/app/runs
      - ../baselines:/app/baselines
      - ${THEME_DIR}:/work/theme

      # Persist CLI config/cache in writable locations (owned by pwuser)
      - shopify_config:/app/.config
      - shopify_cache:/app/.cache

    ports:
      - "3456:3456"
      - "9292:9292"

    environment:
      - PYTHONUNBUFFERED=1

      # Force Node/Shopify CLI to use our writable dirs
      - XDG_CONFIG_HOME=/app/.config
      - XDG_CACHE_HOME=/app/.cache
      - HOME=/app

volumes:
  shopify_config:
  shopify_cache:
